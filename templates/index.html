<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECG Sensor Control</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #333;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 3fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .control-section {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .connection-alert {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            border-radius: 15px;
            padding: 20px;
            color: white;
            text-align: center;
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
            margin-bottom: 20px;
        }

        .connection-alert.connected {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }

        .connection-alert h3 {
            margin-bottom: 10px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .connection-alert p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .status-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            border-left: 4px solid #007bff;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .status-item:last-child {
            margin-bottom: 0;
        }

        .status-label {
            font-weight: 600;
            color: #555;
        }

        .status-value {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .status-connected {
            background: #d4edda;
            color: #155724;
        }

        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-running {
            background: #fff3cd;
            color: #856404;
        }

        .status-stopped {
            background: #f8d7da;
            color: #721c24;
        }

        .config-panel {
            background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
            border-radius: 15px;
            padding: 25px;
            color: white;
            box-shadow: 0 8px 25px rgba(23, 162, 184, 0.3);
        }

        .config-panel h3 {
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .config-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .config-input-group label {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .config-input {
            padding: 12px 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            transition: all 0.3s ease;
        }

        .config-input:focus {
            outline: none;
            background: white;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
        }

        .config-input:disabled {
            background: rgba(255, 255, 255, 0.5);
            color: #666;
            cursor: not-allowed;
        }

        .config-input.error {
            background: rgba(220, 53, 69, 0.9);
            color: white;
        }

        .config-range {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .control-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .control-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .control-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .control-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .control-btn.start {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .control-btn.start:hover:not(:disabled) {
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }

        .control-btn.stop {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .control-btn.stop:hover:not(:disabled) {
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
        }

        .control-btn.record {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
            box-shadow: 0 4px 15px rgba(111, 66, 193, 0.3);
        }

        .control-btn.record:hover:not(:disabled) {
            box-shadow: 0 8px 25px rgba(111, 66, 193, 0.4);
        }

        .control-btn.configure {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
            box-shadow: 0 4px 15px rgba(111, 66, 193, 0.3);
        }

        .control-btn.configure:hover:not(:disabled) {
            box-shadow: 0 8px 25px rgba(111, 66, 193, 0.4);
        }

        .plot-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            border-left: 4px solid #28a745;
        }

        .plot-section h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.2rem;
            text-align: center;
        }

        .plots-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .plot-container {
            height: 200px;
            width: 100%;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #e9ecef;
        }

        .plot-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 15px;
            font-weight: 600;
            font-size: 0.9rem;
            border-radius: 8px 8px 0 0;
        }

        .plot-header.signal1 {
            background: linear-gradient(135deg, #1f77b4 0%, #4a90e2 100%);
        }

        .plot-header.signal2 {
            background: linear-gradient(135deg, #ff7f0e 0%, #ffa726 100%);
        }

        .plot-header.signal3 {
            background: linear-gradient(135deg, #2ca02c 0%, #66bb6a 100%);
        }

        .plot-header.signal4 {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
            color: white;
        }

        .plot-header.signal5 {
            background: linear-gradient(135deg, #e83e8c 0%, #fd7e14 100%);
            color: white;
        }

        .plot-header.signal6 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .log-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .log-panel h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.2rem;
        }

        .log-entry {
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            font-size: 0.9rem;
            border-left: 3px solid #007bff;
        }

        .log-success {
            background: #d4edda;
            color: #155724;
            border-left-color: #28a745;
        }

        .log-error {
            background: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }

        .log-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left-color: #17a2b8;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .config-grid {
                grid-template-columns: 1fr;
            }

            .control-panel {
                grid-template-columns: 1fr;
            }

            .plot-container {
                height: 150px;
            }
        }

        .plots-grid-fixed {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        .plots-grid-fixed .plot-container {
            min-width: 0;
        }
        #container-Lead1 { grid-column: 1; grid-row: 1; }
        #container-Lead2 { grid-column: 2; grid-row: 1; }
        #container-Lead3 { grid-column: 3; grid-row: 1; }
        #container-aVR   { grid-column: 1; grid-row: 2; }
        #container-aVL   { grid-column: 2; grid-row: 2; }
        #container-aVF   { grid-column: 3; grid-row: 2; }
        #container-V1    { grid-column: 1; grid-row: 3; }
        #container-V2    { grid-column: 2; grid-row: 3; }
        #container-V3    { grid-column: 3; grid-row: 3; }
        #container-V4    { grid-column: 1; grid-row: 4; }
        #container-V5    { grid-column: 2; grid-row: 4; }
        #container-V6    { grid-column: 3; grid-row: 4; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ECG Sensor Control</h1>
            <p>Real-time sensor monitoring and control interface</p>
        </div>

        <div class="main-content">
            <div class="control-section">
                <div class="connection-alert" id="connection-alert">
                    <h3>🔌 Serial Connection</h3>
                    <p id="connection-status">Checking connection...</p>
                </div>

                <div class="status-panel">
                    <h3>System Status</h3>
                    <div class="status-item">
                        <span class="status-label">Serial Connection:</span>
                        <span class="status-value" id="serial-status">Checking...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Serial Port:</span>
                        <span class="status-value" id="serial-port">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Baud Rate:</span>
                        <span class="status-value" id="baud-rate">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Sensor Status:</span>
                        <span class="status-value" id="sensor-status">Stopped</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Samples Received:</span>
                        <span class="status-value" id="samplesReceived">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Buffer Size:</span>
                        <span class="status-value" id="bufferSize">0 bytes</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">FIR Filters:</span>
                        <span class="status-value" id="firFiltersStatus">Not Initialized</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Active Connections:</span>
                        <span class="status-value" id="active-connections">0</span>
                    </div>
                </div>

                <div class="config-panel">
                    <h3>⚙️ Sensor Configuration</h3>
                    <div class="config-grid">
                        <div class="config-input-group">
                            <label for="frequency-input">Sampling Frequency (Hz)</label>
                            <select id="frequency-input" class="config-input">
                                <option value="250">250 Hz</option>
                                <option value="500">500 Hz</option>
                                <option value="1000" selected>1000 Hz</option>
                                <option value="2000">2000 Hz</option>
                                <option value="4000">4000 Hz</option>
                                <option value="8000">8000 Hz</option>
                            </select>
                            <div class="config-range">Available: 250, 500, 1000, 2000, 4000, 8000 Hz</div>
                        </div>
                        <div class="config-input-group">
                            <label for="refresh-input">Refresh Rate (Hz)</label>
                            <input 
                                type="number" 
                                id="refresh-input" 
                                class="config-input" 
                                placeholder="10"
                                min="1" 
                                max="60"
                                step="1"
                            >
                            <div class="config-range">Range: 1 - 60 Hz</div>
                        </div>
                    </div>
                    <div style="text-align: center; font-size: 0.9rem; opacity: 0.8;">
                        Configure settings before starting. Settings are locked while sensor is running.
                    </div>
                    <button class="control-btn configure" id="configure-btn" onclick="configureSensor()" style="margin-top: 15px; width: 100%;">
                        ⚙️ Configure Sensor
                    </button>
                </div>

                <div class="control-panel">
                    <button class="control-btn start" id="start-btn" onclick="sendCommand('start')">
                        ▶ Start
                    </button>
                    <button class="control-btn stop" id="stop-btn" onclick="sendCommand('stop')">
                        ⏹ Stop
                    </button>
                    <button class="control-btn record" id="record-btn" onclick="sendCommand('record')">
                        🔴 Record
                    </button>
                </div>
            </div>

            <div class="plot-section">
                <h3>📊 Real-Time ECG Signals (FIR Filtered)</h3>
                <div id="plot-checkboxes" style="margin-bottom: 10px; text-align: center;">
                    <button id="show-all-btn" type="button" style="margin-right: 10px; padding: 5px 15px; border-radius: 8px; border: none; background: #667eea; color: white; font-weight: 600; cursor: pointer;">Show All</button>
                    <label style="margin-right: 10px;">Y-Scale:
                        <select id="yscale-select" style="margin-left: 5px; padding: 3px 8px; border-radius: 6px;">
                            <option value="dynamic">Dynamic</option>
                            <option value="fixed">Fixed</option>
                        </select>
                    </label>
                    <label><input type="checkbox" class="plot-toggle" data-plot="Lead1" checked> Lead I</label>
                    <label><input type="checkbox" class="plot-toggle" data-plot="Lead2" checked> Lead II</label>
                    <label><input type="checkbox" class="plot-toggle" data-plot="Lead3" checked> Lead III</label>
                    <label><input type="checkbox" class="plot-toggle" data-plot="aVR"> aVR</label>
                    <label><input type="checkbox" class="plot-toggle" data-plot="V1" checked> V1</label>
                    <label><input type="checkbox" class="plot-toggle" data-plot="V2"> V2</label>
                    <label><input type="checkbox" class="plot-toggle" data-plot="V3"> V3</label>
                    <label><input type="checkbox" class="plot-toggle" data-plot="aVL" checked> aVL</label>
                    <label><input type="checkbox" class="plot-toggle" data-plot="V4"> V4</label>
                    <label><input type="checkbox" class="plot-toggle" data-plot="V5"> V5</label>
                    <label><input type="checkbox" class="plot-toggle" data-plot="V6"> V6</label>
                    <label><input type="checkbox" class="plot-toggle" data-plot="aVF" checked> aVF</label>
                </div>
                <div class="plots-grid-fixed">
                    <div class="plot-container" id="container-Lead1">
                        <div class="plot-header signal1">Lead I (Filtered)</div>
                        <div id="plot-Lead1" style="width:100%; height:150px;"></div>
                    </div>
                    <div class="plot-container" id="container-Lead2">
                        <div class="plot-header signal2">Lead II (Filtered)</div>
                        <div id="plot-Lead2" style="width:100%; height:150px;"></div>
                    </div>
                    <div class="plot-container" id="container-Lead3">
                        <div class="plot-header signal4">Lead III (Filtered)</div>
                        <div id="plot-Lead3" style="width:100%; height:150px;"></div>
                    </div>
                    <div class="plot-container" id="container-aVR">
                        <div class="plot-header signal6">aVR (Filtered)</div>
                        <div id="plot-aVR" style="width:100%; height:150px;"></div>
                    </div>
                    <div class="plot-container" id="container-aVL">
                        <div class="plot-header signal5">aVL (Filtered)</div>
                        <div id="plot-aVL" style="width:100%; height:150px;"></div>
                    </div>
                    <div class="plot-container" id="container-aVF">
                        <div class="plot-header signal6">aVF (Filtered)</div>
                        <div id="plot-aVF" style="width:100%; height:150px;"></div>
                    </div>
                    <div class="plot-container" id="container-V1">
                        <div class="plot-header signal3">V1 (Filtered)</div>
                        <div id="plot-V1" style="width:100%; height:150px;"></div>
                    </div>
                    <div class="plot-container" id="container-V2">
                        <div class="plot-header signal3">V2 (Filtered)</div>
                        <div id="plot-V2" style="width:100%; height:150px;"></div>
                    </div>
                    <div class="plot-container" id="container-V3">
                        <div class="plot-header signal3">V3 (Filtered)</div>
                        <div id="plot-V3" style="width:100%; height:150px;"></div>
                    </div>
                    <div class="plot-container" id="container-V4">
                        <div class="plot-header signal3">V4 (Filtered)</div>
                        <div id="plot-V4" style="width:100%; height:150px;"></div>
                    </div>
                    <div class="plot-container" id="container-V5">
                        <div class="plot-header signal3">V5 (Filtered)</div>
                        <div id="plot-V5" style="width:100%; height:150px;"></div>
                    </div>
                    <div class="plot-container" id="container-V6">
                        <div class="plot-header signal3">V6 (Filtered)</div>
                        <div id="plot-V6" style="width:100%; height:150px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="log-panel">
            <h3>Command Log</h3>
            <div id="log-container">
                <div class="log-entry log-info">System initialized. Configure settings and press Start.</div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        const logMaxEntries = 50;
        const statusUpdateInterval = 5000;
        let isRunning = false;
        let currentFrequency = 100;
        let currentRefreshRate = 10;
        let serialConnected = false;

        // Plot data storage for each signal
        let plotData = {
            timestamps: [],
            Lead1: [],
            Lead2: [],
            V1: [],
            V2: [],
            V3: [],
            V4: [],
            V5: [],
            V6: [],
            Lead3: [],
            aVL: [],
            aVR: [],
            aVF: []
        };

        // Y-axis fixed ranges for each lead
        const yAxisFixedRanges = {
            Lead1: [0.4, 1.2],
            Lead2: [-0.3, 0.7],
            Lead3: [-0.8, -0.2],
            aVR: [-1, -0.1],
            aVL: [0.5, 0.7],
            aVF: [-0.6, 0.2],
            V1: [-0.4, 0.2],
            V2: [-1, 0.1],
            V3: [-0.6, 0.1],
            V4: [-0.6, 0.6],
            V5: [-0.6, 0.6],
            V6: [0, 1]
        };
        let yScaleMode = 'dynamic';

        // Initialize individual Plotly plots
        function initPlots() {
            const plotConfig = {
                responsive: true,
                displayModeBar: false
            };
            const plotDefs = [
                { key: 'Lead1', color: '#1f77b4', label: 'Lead I (Filtered)' },
                { key: 'Lead2', color: '#ff7f0e', label: 'Lead II (Filtered)' },
                { key: 'V1', color: '#2ca02c', label: 'V1 (Filtered)' },
                { key: 'V2', color: '#17a2b8', label: 'V2 (Filtered)' },
                { key: 'V3', color: '#e377c2', label: 'V3 (Filtered)' },
                { key: 'V4', color: '#bcbd22', label: 'V4 (Filtered)' },
                { key: 'V5', color: '#8c564b', label: 'V5 (Filtered)' },
                { key: 'V6', color: '#9467bd', label: 'V6 (Filtered)' },
                { key: 'Lead3', color: '#6f42c1', label: 'Lead III (Filtered)' },
                { key: 'aVL', color: '#e83e8c', label: 'aVL (Filtered)' },
                { key: 'aVR', color: '#fd7e14', label: 'aVR (Filtered)' },
                { key: 'aVF', color: '#667eea', label: 'aVF (Filtered)' }
            ];
            plotDefs.forEach(def => {
                Plotly.newPlot(
                    `plot-${def.key}`,
                    [{ y: [], name: def.label, type: 'scatter', mode: 'lines', line: { color: def.color, width: 2 }, showlegend: false }],
                    {
                        height: 150,
                        margin: { l: 40, r: 20, t: 20, b: 30 },
                        xaxis: {
                            title: 'Time (s)',
                            showgrid: true,
                            gridcolor: '#e1e5e9',
                            titlefont: { size: 10 },
                            tickfont: { size: 9 }
                        },
                        yaxis: {
                            title: 'Amplitude',
                            showgrid: true,
                            gridcolor: '#e1e5e9',
                            titlefont: { size: 10 },
                            tickfont: { size: 9 }
                        },
                        plot_bgcolor: 'white',
                        paper_bgcolor: 'white',
                        font: { size: 10 }
                    },
                    plotConfig
                );
            });
        }
        flag = false;
        t0 = 0;
        // Update individual plots with new data
        function updatePlots(timestamps, allSignals) {
            plotData.timestamps = timestamps;
            Object.keys(allSignals).forEach(key => {
                plotData[key] = allSignals[key];
            });
            if (flag == false) {
                t0 = plotData.timestamps[0];
                flag = true;
            }
            // Use raw timestamps directly for the x-axis
            let absTime = plotData.timestamps;
            absTime = absTime.map(t => t - t0);
            Object.keys(allSignals).forEach(key => {
                let update = {
                    x: [absTime],
                    y: [plotData[key]]
                };
                if (yScaleMode === 'fixed' && yAxisFixedRanges[key]) {
                    update['yaxis.range'] = [yAxisFixedRanges[key][0], yAxisFixedRanges[key][1]];
                    Plotly.relayout(`plot-${key}`, { 'yaxis.autorange': false, 'yaxis.range': yAxisFixedRanges[key] });
                } else {
                    Plotly.relayout(`plot-${key}`, { 'yaxis.autorange': true });
                }
                Plotly.restyle(`plot-${key}`, update);
            });
        }

        // Show/hide plots based on checkboxes
        function setupPlotToggles() {
            document.querySelectorAll('.plot-toggle').forEach(cb => {
                cb.addEventListener('change', function() {
                    const plotKey = this.getAttribute('data-plot');
                    const container = document.getElementById(`container-${plotKey}`);
                    if (this.checked) {
                        container.style.visibility = '';
                    } else {
                        container.style.visibility = 'hidden';
                    }
                });
            });
            // Show All button
            document.getElementById('show-all-btn').addEventListener('click', function() {
                document.querySelectorAll('.plot-toggle').forEach(cb => {
                    cb.checked = true;
                    const plotKey = cb.getAttribute('data-plot');
                    const container = document.getElementById(`container-${plotKey}`);
                    container.style.visibility = '';
                });
            });
        }

        // Update connection status display
        function updateConnectionStatus(connected) {
            serialConnected = connected;
            const alert = document.getElementById('connection-alert');
            const status = document.getElementById('connection-status');
            
            if (connected) {
                alert.className = 'connection-alert connected';
                status.textContent = '✅ Connected to sensor';
            } else {
                alert.className = 'connection-alert';
                status.textContent = '❌ Not connected to sensor';
            }
        }

        // Initialize WebSocket connection
        function initWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                addLog('WebSocket connected', 'info');
                reconnectAttempts = 0;
            };
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (e) {
                    addLog(`Message: ${event.data}`, 'info');
                }
            };
            
            ws.onclose = function() {
                addLog('WebSocket disconnected', 'error');
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    setTimeout(initWebSocket, 2000);
                }
            };
            
            ws.onerror = function(error) {
                addLog('WebSocket error', 'error');
            };
        }

        // Handle WebSocket messages
        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'plot_data':
                    // Use downsampled arrays for all 12 leads
                    const timestamps = data.downsampled_timestamps || [];
                    const allSignals = {
                        Lead1: data.downsampled_Lead1 || [],
                        Lead2: data.downsampled_Lead2 || [],
                        V1: data.downsampled_V1 || [],
                        V2: data.downsampled_V2 || [],
                        V3: data.downsampled_V3 || [],
                        V4: data.downsampled_V4 || [],
                        V5: data.downsampled_V5 || [],
                        V6: data.downsampled_V6 || [],
                        Lead3: data.downsampled_Lead3 || [],
                        aVL: data.downsampled_aVL || [],
                        aVR: data.downsampled_aVR || [],
                        aVF: data.downsampled_aVF || []
                    };
                    updatePlots(timestamps, allSignals);
                    if (data.samples_received !== undefined) {
                        document.getElementById('samplesReceived').textContent = data.samples_received;
                    }
                    if (data.buffer_size !== undefined) {
                        document.getElementById('bufferSize').textContent = `${data.buffer_size} bytes`;
                    }
                    break;
                    
                case 'command_response':
                    handleCommandResponse(data);
                    break;
                    
                case 'config_update':
                    updateConfiguration(data);
                    break;
                    
                default:
                    console.log('Unknown message type:', data.type);
            }
        }

        // Handle command responses from WebSocket
        function handleCommandResponse(data) {
            const status = data.result.status;
            const message = data.result.message;
            let logMessage = `${data.command.toUpperCase()}: ${message}`;
            
            // Add frequency and refresh rate info for start command
            if (data.command === 'start' && data.frequency && data.refresh_rate) {
                logMessage += ` (${data.frequency} Hz, ${data.refresh_rate} Hz refresh)`;
            }
            
            addLog(logMessage, status);
            
            // Update running state
            if (data.is_running !== undefined) {
                isRunning = data.is_running;
                updateUIState();
            }
        }

        // Update configuration from WebSocket
        function updateConfiguration(data) {
            currentFrequency = data.frequency;
            currentRefreshRate = data.refresh_rate;
            updateConfigDisplay();
            addLog(`Configuration updated: ${data.frequency} Hz, ${data.refresh_rate} Hz refresh`, 'success');
        }

        // Configure sensor settings
        async function configureSensor() {
            if (!serialConnected) {
                addLog('Cannot configure: Serial connection not available', 'error');
                return;
            }
            
            if (isRunning) {
                addLog('Cannot configure: Sensor is running', 'error');
                return;
            }
            
            const frequency = parseInt(document.getElementById('frequency-input').value);
            const refreshRate = parseInt(document.getElementById('refresh-input').value);
            
            try {
                const response = await fetch('/configure', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        frequency: frequency,
                        refresh_rate: refreshRate
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    currentFrequency = frequency;
                    currentRefreshRate = refreshRate;
                    updateConfigDisplay();
                    addLog(`Configuration applied: ${frequency} Hz, ${refreshRate} Hz refresh`, 'success');
                } else {
                    addLog(`Configuration error: ${result.detail}`, 'error');
                }
            } catch (error) {
                addLog(`Configuration error: ${error.message}`, 'error');
            }
        }

        // Update UI state based on running status and connection
        function updateUIState() {
            const frequencyInput = document.getElementById('frequency-input');
            const refreshInput = document.getElementById('refresh-input');
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const recordBtn = document.getElementById('record-btn');
            const configureBtn = document.getElementById('configure-btn');
            const sensorStatus = document.getElementById('sensor-status');
            
            // Disable all controls if not connected
            const controlsDisabled = !serialConnected;
            
            if (isRunning) {
                // Lock configuration inputs
                frequencyInput.disabled = true;
                refreshInput.disabled = true;
                configureBtn.disabled = true;
                
                // Update button states
                startBtn.disabled = true;
                stopBtn.disabled = controlsDisabled;
                recordBtn.disabled = controlsDisabled;
                
                // Update status
                sensorStatus.textContent = 'Running';
                sensorStatus.className = 'status-value status-running';
                
                if (!controlsDisabled) {
                    addLog('Sensor is now running. Configuration is locked.', 'info');
                }
            } else {
                // Unlock configuration inputs
                frequencyInput.disabled = controlsDisabled;
                refreshInput.disabled = controlsDisabled;
                configureBtn.disabled = controlsDisabled;
                
                // Update button states
                startBtn.disabled = controlsDisabled;
                stopBtn.disabled = true;
                recordBtn.disabled = controlsDisabled;
                
                // Update status
                sensorStatus.textContent = 'Stopped';
                sensorStatus.className = 'status-value status-stopped';
                
                if (!controlsDisabled) {
                    addLog('Sensor stopped. Configuration is now unlocked.', 'info');
                }
            }
        }

        // Update configuration display
        function updateConfigDisplay() {
            document.getElementById('frequency-input').value = currentFrequency;
            document.getElementById('refresh-input').value = currentRefreshRate;
        }

        // Send command to server
        async function sendCommand(command) {
            if (!serialConnected) {
                addLog('Cannot send command: Serial connection not available', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/command/${command}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                let logMessage = `${command.toUpperCase()}: ${result.message}`;
                
                // Add frequency and refresh rate info for start command
                if (command === 'start') {
                    logMessage += ` (${currentFrequency} Hz, ${currentRefreshRate} Hz refresh)`;
                }
                
                addLog(logMessage, result.status);
                
                // Update status
                updateStatus();
                
            } catch (error) {
                addLog(`Error sending command: ${error.message}`, 'error');
            }
        }

        // Add log entry
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Keep only last N entries
            while (logContainer.children.length > logMaxEntries) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        // Update system status
        async function updateStatus() {
            try {
                const response = await fetch('/status');
                const status = await response.json();
                
                // Update connection status
                const connected = status.serial_status === 'connected';
                updateConnectionStatus(connected);
                
                document.getElementById('serial-status').textContent = status.serial_status;
                document.getElementById('serial-status').className = `status-value status-${status.serial_status}`;
                document.getElementById('serial-port').textContent = status.serial_port;
                document.getElementById('baud-rate').textContent = status.baud_rate;
                document.getElementById('active-connections').textContent = status.active_connections;
                
                // Update sensor data information
                document.getElementById('samplesReceived').textContent = status.samples_received || 0;
                document.getElementById('bufferSize').textContent = `${status.buffer_size || 0} bytes`;
                
                // Update FIR filter status
                const firStatusElement = document.getElementById('firFiltersStatus');
                if (status.fir_filters_initialized) {
                    firStatusElement.textContent = 'Initialized';
                    firStatusElement.className = 'status-value status-connected';
                } else {
                    firStatusElement.textContent = 'Not Initialized';
                    firStatusElement.className = 'status-value status-disconnected';
                }
                
                // Update local variables
                isRunning = status.is_running;
                currentFrequency = status.current_frequency;
                currentRefreshRate = status.current_refresh_rate;
                
                // Update UI
                updateUIState();
                updateConfigDisplay();
                
            } catch (error) {
                addLog(`Error updating status: ${error.message}`, 'error');
            }
        }

        // Load configuration
        async function loadConfiguration() {
            try {
                const response = await fetch('/configure');
                const config = await response.json();
                
                currentFrequency = config.frequency;
                currentRefreshRate = config.refresh_rate;
                isRunning = config.is_running;
                
                updateConfigDisplay();
                updateUIState();
                
            } catch (error) {
                addLog(`Error loading configuration: ${error.message}`, 'error');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initPlots();
            initWebSocket();
            updateStatus();
            loadConfiguration();
            setupPlotToggles();
            
            // Update status at configured interval
            setInterval(updateStatus, statusUpdateInterval);
            
            // Handle Enter key in refresh rate input
            document.getElementById('refresh-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !isRunning && serialConnected) {
                    configureSensor();
                }
            });
            
            // Handle change event for frequency dropdown
            document.getElementById('frequency-input').addEventListener('change', function(e) {
                if (!isRunning && serialConnected) {
                    // Optionally auto-configure when frequency changes
                    // configureSensor();
                }
            });

            document.getElementById('yscale-select').addEventListener('change', function() {
                yScaleMode = this.value;
                // Force update of y-axis for all plots
                updatePlots(plotData.timestamps, plotData);
            });
        });
    </script>
</body>
</html> 